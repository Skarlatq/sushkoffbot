import logging
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    filters,
    ContextTypes,
    ConversationHandler,
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ò!)
import os
TOKEN = os.environ.get('TOKEN')
WAREHOUSE_CHAT_ID = -1002322687297  # ID —á–∞—Ç–∞ —Å–∫–ª–∞–¥–∞

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
SELECT_DEPARTMENT, INPUT_QUANTITY, INPUT_UNIT, CONFIRM_ORDER = range(4)

# –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
BACK_BUTTON = "‚óÄ –ù–∞–∑–∞–¥"
CHANGE_DEPARTMENT_BUTTON = "üîÅ –°–º–µ–Ω–∏—Ç—å –æ—Ç–¥–µ–ª"
NEW_ORDER_BUTTON = "üîÑ –ù–æ–≤—ã–π –∑–∞–∫–∞–∑"
CANCEL_BUTTON = "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å"
SKIP_BUTTON = "‚è≠ –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç"

# –û—Ç–¥–µ–ª—ã –∏ –∏—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã (—Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
departments = {
    "–†–æ–ª–ª—ã": [
        "–°—ã—Ä –¥–ª—è —Ä–æ–ª–ª–æ–≤", "–ë–µ–∫–æ–Ω", "–õ–æ—Å–æ—Å—å —á–µ—Ä–Ω—É—Ö–∞", "–ö–æ–ø—á–µ–Ω–∞—è –∫—É—Ä–∏—Ü–∞",
        "–õ–æ—Å–æ—Å—å —Ñ–∏–ª–∞", "–õ–æ—Å–æ—Å—å —à–Ω—è–≥–∞", "–ú–∞—Å–ª—è–Ω–∞—è —Ä—ã–±–∞", "–£–≥–æ—Ä—å", "–¢—É–Ω–µ—Ü",
        "–ö–ª–∞—Ä–∏–π", "–ö—Ä–µ–≤–µ—Ç–∫–∏ –±–ª–æ–∫", "–ö—Ä–∞–±", "–ß—É–∫–∞",
        "–°–æ—É—Å –∫—É–Ω–∂—É—Ç–Ω—ã–π", "–ú–∞—Å–∞–≥–æ –æ—Ä–∞–Ω–∂", "–ú–∞—Å–∞–≥–æ –º–∞–ª–∏–Ω", "–£–Ω–∞–≥–∏ —Å–æ—É—Å",
        "–ú–∞–π–æ–Ω–µ–∑", "–ö–∏–º—á–∏", "–°—É—Ö–∞—Ä–∏", "–ú—É–∫–∞ —Ç–µ–º–ø—É—Ä–∞", "–ö—Ä–∞—Ö–º–∞–ª",
        "–®–∏–∏—Ç–∞–∫—ç", "–¢–∞–∫—É–∞–Ω", "–û–≥—É—Ä–µ—Ü", "–ê–≤–æ–∫–∞–¥–æ",
        "–Ø–ø–æ–Ω—Å–∫–æ–µ —Ç–µ—Å—Ç–æ", "–ü–∞–∫–µ—Ç —Ä—É–ª–æ–Ω", "–¶–∏–Ω–æ–≤–∫–∞", 
        "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–æ–ª—å–≥–∏—Ä", "–õ–∞–Ω—á –±–æ–∫—Å –º/–±", "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –º/–±",
        "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç–æ–ª –º/–±", "–ü–ª–µ–Ω–∫–∞ –ø–∏—â–µ–≤–∞—è", "–ü–æ–ª–æ—Ç–µ–Ω—Ü–µ –±—É–º–∞–∂",
        "–§–æ–ª—å–≥–∞", "–ü–∞–∫–µ—Ç –º—É—Å (–º,–±)",
        "–ö—É–Ω–∂—É—Ç –±–µ–ª/—á–µ—Ä–Ω", "–ú–∞—Å–ª–æ —Ñ—Ä–∏—Ç—é—Ä", "–†–∏—Å", "–ù–æ—Ä–∏",
        "–°—Ç—Ä—É–∂–∫–∞ —Ç—É–Ω—Ü–∞", "–ú–∏—Ü—É–∫–∞–Ω",
        "–ü–µ—Ä—á–∞—Ç–∫–∏ —Ü–µ–ª–æ—Ñ –º,l", "–ü–µ—Ä—á–∞—Ç–∫–∏ –≤–∏–Ω–∏–ª"
    ],
    "–ü–∏—Ü—Ü–∞": [
        "–ì–∞—É–¥–∞", "–î–æ—Ä-–±–ª—é", "–ü–∞—Ä–º–µ–∑–∞–Ω", "–ú–æ—Ü–∞—Ä–µ–ª–ª–∞",
        "–í–µ—Ç—á–∏–Ω–∞", "–°–∞–ª—è–º–∏", "–ö–æ–ø—á–µ–Ω–∞—è –∫—É—Ä–∏—Ü–∞", "–û–∫–æ—Ä–æ–∫ —Å–≤–∏–Ω–æ–π",
        "–ì—Ä—É–¥–∏–Ω–∫–∞ —Å–≤–∏–Ω–∞—è", "–ü–µ–ø–ø–µ—Ä–æ–Ω–∏", "–ì–æ–≤—è–¥–∏–Ω–∞ –≤–∞—Ä–µ–Ω–∞—è",
        "–ö—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ —Ñ–∞—Ö–∏—Ç–æ", "–ö—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ –±–∞—Ä–±–µ–∫—é",
        "–ú–æ—Ä—Å–∫–æ–π –∫–æ–∫—Ç–µ–π–ª—å", "–ö—Ä–µ–≤–µ—Ç–∫–∏ –∫–æ–∫—Ç–µ–π–ª—å–Ω—ã–µ", "–ú–∏–¥–∏–∏", "–ö–∞–ª—å–º–∞—Ä",
        "–ê–Ω–∞–Ω–∞—Å", "–ú–∞—Å–ª–∏–Ω—ã", "–û–ª–∏–≤–∫–∏", "–®–∞–º–ø–∏–Ω—å–æ–Ω—ã", "–û–≥—É—Ä—Ü—ã —Å–æ–ª–µ–Ω—ã–µ",
        "–°–æ—É—Å –∫—Ä–∞—Å–Ω—ã–π", "–ú–∞–π–æ–Ω–µ–∑", "–°–æ—É—Å –±—É—Ä–≥–µ—Ä", "–°–æ—É—Å —Ü–µ–∑–∞—Ä—å", 
        "–°–æ—É—Å –±–∞—Ä–±–µ–∫—é", "–°–æ—É—Å —Ä–∞–Ω—á", "–°–æ—É—Å –∫–∏—Å–ª–æ-—Å–ª–∞–¥–∫–∏–π",
        "–ú—É–∫–∞ –¥–ª—è –ø–∏—Ü—Ü—ã", "–ú—É–∫–∞ –∫—Ä—É–ø–∫–∞", "–î—Ä–æ–∂–∂–∏", "–°–ø–µ—Ü–∏–∏ —Ñ–∞—Ö–∏—Ç–æ",
        "–ö–æ—Ä–æ–±–∫–∞ –¥–ª—è –ø–∏—Ü—Ü—ã 26—Å–º", "–ö–æ—Ä–æ–±–∫–∞ –¥–ª—è –ø–∏—Ü—Ü—ã 33—Å–º", "–ö–æ—Ä–æ–±–∫–∞ –¥–ª—è –ø–∏—Ü—Ü—ã 40—Å–º",
        "–ü–∞–∫–µ—Ç –¥–ª—è –ø–∏—Ü—Ü—ã –º–∞–ª—ã–π", "–ü–∞–∫–µ—Ç –¥–ª—è –ø–∏—Ü—Ü—ã –±–æ–ª—å—à–æ–π", "–ü–µ—Ä–≥–∞–º–µ–Ω—Ç",
        "–ü–µ—Ä—á–∞—Ç–∫–∏ —Ü–µ–ª–æ—Ñ–∞–Ω–æ–≤—ã–µ M", "–ü–µ—Ä—á–∞—Ç–∫–∏ —Ü–µ–ª–æ—Ñ–∞–Ω–æ–≤—ã–µ L",
        "–ü–∞–∫–µ—Ç—ã –º—É—Å–æ—Ä–Ω—ã–µ –º–∞–ª—ã–µ", "–ü–∞–∫–µ—Ç—ã –º—É—Å–æ—Ä–Ω—ã–µ –±–æ–ª—å—à–∏–µ"
    ],
    "–ì–æ—Ä—è—á–∏–π —Ü–µ—Ö": [
        "–ë–∞–π—Ç—Å—ã", "–ö–æ–ª—å—Ü–∞ –∫–∞–ª—å–º–∞—Ä–∞", "–ù–∞–≥–≥–µ—Ç—Å—ã", "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å —Ñ—Ä–∏", 
        "–õ—É–∫–æ–≤—ã–µ –∫–æ–ª—å—Ü–∞", "–§–∞—Å–æ–ª—å —Å—Ç—Ä—É—á–∫–æ–≤–∞—è", "–ü–µ—Ä–µ—Ü –±–æ–ª–≥–∞—Ä—Å–∫–∏–π",
        "–£–¥–æ–Ω", "–°–æ–±–∞", "–†–∞–º–µ–Ω", "–§—É–Ω—á–æ–∑–∞",
        "–°–∏—Ä–æ–ø", "–¢–æ–ø–ø–∏–Ω–≥", "–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç –∫—É—Ä–∏–Ω—ã–π", "–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ç —Ä—ã–±–Ω—ã–π",
        "–ü–µ—Ä–µ—Ü —á–µ—Ä–Ω—ã–π –º–æ–ª–æ—Ç—ã–π", "–°–æ—É—Å –∫–∏—Å–ª–æ-—Å–ª–∞–¥–∫–∏–π", "–°–æ—É—Å —Ç–µ—Ä–∏—è–∫–∏",
        "–®—Ä–∏—Ä–∞—á–∞", "–°–æ—É—Å –∫—É–Ω–∂—É—Ç–Ω—ã–π", "–í–∞–∫–∞–º–µ", "–¢–æ–º —è–º", 
        "–ö–æ–∫–æ—Å–æ–≤–æ–µ –º–æ–ª–æ–∫–æ", "–ü–∞–¥–∞–º —á–∏—Å—Ç—ã–π", "–ü–æ–¥—Å–æ–ª–Ω–µ—á–Ω–æ–µ –º–∞—Å–ª–æ", "–ú–∞—Å–ª–æ —Ñ—Ä–∏—Ç—é—Ä–Ω–æ–µ",
        "–ú–æ–ª–æ–∫–æ", "–ë—É–ª–æ—á–∫–∏ –±–µ–ª—ã–µ", "–ë—É–ª–æ—á–∫–∏ —á–µ—Ä–Ω—ã–µ", "–ú–æ—Ä–æ–∂–µ–Ω–æ–µ –ø–ª–æ–º–±–∏—Ä",
        "–ü–∞–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–µ —Å—É—Ö–∞—Ä–∏", "–ú—É–∫–∞ —Ç–µ–º–ø—É—Ä–∞", "–ö—Ä–∞—Ö–º–∞–ª",
        "–ö–æ—Ä–æ–±–∫–∞ –¥–ª—è –≤–æ–∫", "–°—É–ø–Ω–∏—Ü–∞", "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–æ—É–ª—ã", 
        "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–æ–∫—Å—ã", "–ö–æ—Ä–æ–±–∫–∞ –¥–ª—è —Ñ—Ä–∏ –º–∞–ª–∞—è", 
        "–ö–æ—Ä–æ–±–∫–∞ –¥–ª—è —Ñ—Ä–∏ –±–æ–ª—å—à–∞—è", "–°–æ—É—Å–Ω–∏–∫ 50–º–ª", "–°–æ—É—Å–Ω–∏–∫ 80–º–ª",
        "–°—Ç–∞–∫–∞–Ω—ã –∫–æ–∫—Ç–µ–π–ª—å–Ω—ã–µ 0.3–ª", "–°—Ç–∞–∫–∞–Ω—ã –∫–æ–∫—Ç–µ–π–ª—å–Ω—ã–µ 0.5–ª",
        "–ö—Ä—ã—à–∫–∏ –¥–ª—è –∫–æ–∫—Ç–µ–π–ª–µ–π", "–ö—Ä–µ–º–∞–Ω–∫–∞ –¥–ª—è –º–æ—Ä–æ–∂–µ–Ω–æ–≥–æ",
        "–°—Ä–µ–¥—Å—Ç–≤–æ –¥–ª—è –ø–æ—Å—É–¥—ã", "–ê–Ω—Ç–∏–∂–∏—Ä", 
        "–ü–∞–∫–µ—Ç—ã –º—É—Å–æ—Ä–Ω—ã–µ –º–∞–ª—ã–µ", "–ü–∞–∫–µ—Ç—ã –º—É—Å–æ—Ä–Ω—ã–µ –±–æ–ª—å—à–∏–µ",
        "–¢—Ä—è–ø–∫–∏", "–ì—É–±–∫–∏", "–¢–µ—Ä–∫–∏", "–¢—Ä—è–ø–∫–∞ –¥–ª—è –ø–æ–ª–∞",
        "–ü–µ—Ä—á–∞—Ç–∫–∏ —Ü–µ–ª–æ—Ñ–∞–Ω–æ–≤—ã–µ M", "–ü–µ—Ä—á–∞—Ç–∫–∏ —Ü–µ–ª–æ—Ñ–∞–Ω–æ–≤—ã–µ L",
        "–ü–µ—Ä—á–∞—Ç–∫–∏ –≤–∏–Ω–∏–ª–æ–≤—ã–µ", "–ü–ª–µ–Ω–∫–∞ –ø–∏—â–µ–≤–∞—è", "–§–æ–ª—å–≥–∞"
    ],
    "–ö–∞—Å—Å–∞": [
        "–°–æ—É—Å —á–µ—Å–Ω–æ—á–Ω—ã–π 25–º–ª", "–°–æ—É—Å —Å—ã—Ä–Ω—ã–π 25–º–ª", "–°–æ—É—Å –∫–µ—Ç—á—É–ø 25–º–ª", 
        "–°–æ—É—Å –±–∞—Ä–±–µ–∫—é 25–º–ª", "–°–æ—É—Å –∫–∏—Å–ª–æ-—Å–ª–∞–¥–∫–∏–π 25–º–ª",
        "–í–æ–¥–∞ 5–ª", "–í–æ–¥–∞ 20–ª",
        "–ß–∞–π —á–µ—Ä–Ω—ã–π", "–ß–∞–π –∑–µ–ª–µ–Ω—ã–π", "–ß–∞–π —Ñ—Ä—É–∫—Ç–æ–≤—ã–π",
        "–ö–æ–ª–∞ 0.3–ª", "–ö–æ–ª–∞ 0.5–ª", "–ö–æ–ª–∞ 1–ª", "–ö–æ–ª–∞ 2–ª",
        "–§–∞–Ω—Ç–∞ 0.3–ª", "–§–∞–Ω—Ç–∞ 0.5–ª",
        "–°–ø—Ä–∞–π—Ç 0.3–ª", "–°–ø—Ä–∞–π—Ç 0.5–ª",
        "–í–æ–¥–∞ –≥–∞–∑.", "–í–æ–¥–∞ –Ω–µ –≥–∞–∑.",
        "–°–æ–∫ 0.33–ª (–∞–ø–µ–ª—å—Å–∏–Ω)", "–°–æ–∫ 0.33–ª (–º—É–ª—å—Ç–∏—Ñ—Ä—É–∫—Ç)", "–°–æ–∫ 0.33–ª (—è–±–ª–æ–∫–æ)",
        "–°–æ–∫ 1–ª (–∞–ø–µ–ª—å—Å–∏–Ω)", "–°–æ–∫ 1–ª (–º—É–ª—å—Ç–∏—Ñ—Ä—É–∫—Ç)", "–°–æ–∫ 1–ª (—è–±–ª–æ–∫–æ)",
        "–ö–æ—Ñ–µ", "–°–∏—Ä–æ–ø", "–ú–æ–ª–æ–∫–æ",
        "–°–∞—Ö–∞—Ä –ø–æ—Ä—Ü.", "–°–æ–ª—å –ø–æ—Ä—Ü.", "–ü–µ—Ä–µ—Ü –ø–æ—Ä—Ü.", "–í–∞—Å–∞–±–∏", "–ò–º–±–∏—Ä—å",
        "–°–æ–µ–≤—ã–π —Å–æ—É—Å –∫–æ—Ä–æ–±–∫–∞",
        "–í–∏–ª–∫–∞", "–ù–æ–∂", "–õ–æ–∂–∫–∞ –º.", "–õ–æ–∂–∫–∞ –±.", "–ó—É–±–æ—á–∏—Å—Ç–∫–∞",
        "–ü–∞–ª–æ—á–∫–∏ –¥–ª—è —Ä–∞–∑–º–µ—à–∏–≤–∞–Ω–∏—è", "–ü–∞–ª–æ—á–∫–∏ –¥–ª—è —Å—É—à–∏",
        "–°—Ç–∞–∫–∞–Ω –¥–ª—è –∫–æ—Ñ–µ 0.2–ª", "–°—Ç–∞–∫–∞–Ω –¥–ª—è –∫–æ—Ñ–µ 0.3–ª",
        "–ö—Ä—ã—à–∫–∞ –∫–æ—Ñ–µ 0.2–ª", "–ö—Ä—ã—à–∫–∞ –∫–æ—Ñ–µ 0.35–ª", "–ö—Ä—ã—à–∫–∞ —Ñ–æ–ª—å–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è",
        "–¢—Ä—É–±–æ—á–∫–∏ –∫–æ–∫—Ç–µ–π–ª—å–Ω—ã–µ", "–°–æ—É—Å–Ω–∏–∫ 30–º–ª", "–°–æ—É—Å–Ω–∏–∫ 50–º–ª", "–°–æ—É—Å–Ω–∏–∫ 80–º–ª",
        "–¢–∞—Ä–µ–ª–∫–∞", "–ö—Ä–µ–º–∞–Ω–∫–∞ –¥–ª—è –º–æ—Ä–æ–∂–µ–Ω–æ–≥–æ",
        "–ü–∞–∫–µ—Ç –¥–ª—è –ø–∏—Ü—Ü—ã –º.", "–ü–∞–∫–µ—Ç –¥–ª—è –ø–∏—Ü—Ü—ã –±.",
        "–ü–∞–∫–µ—Ç –¥–ª—è –∑–∞–∫—É—Å–æ–∫ –º.", "–ü–∞–∫–µ—Ç –¥–ª—è –∑–∞–∫—É—Å–æ–∫ –±.",
        "–ü–∞–∫–µ—Ç –º–∞–π–∫–∞", "–ö–æ—Ä–æ–±–∫–∞ –¥–ª—è –≤–æ–∫", "–°—É–ø–Ω–∏—Ü–∞",
        "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–æ—É–ª—ã", "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–æ–∫—Å—ã",
        "–°—Ç–∞–∫–∞–Ω—ã –∫–æ–∫—Ç. 0.3–ª", "–°—Ç–∞–∫–∞–Ω—ã –∫–æ–∫—Ç. 0.5–ª",
        "–ö—Ä—ã—à–∫–∏ –¥–ª—è –∫–æ–∫—Ç–µ–π–ª–µ–π", "–î–µ—Ä–∂–∞—Ç–µ–ª–∏ —Å—Ç–∞–∫–∞–Ω–æ–≤ (2 –º–µ—Å—Ç–∞)", 
        "–î–µ—Ä–∂–∞—Ç–µ–ª–∏ —Å—Ç–∞–∫–∞–Ω–æ–≤ (4 –º–µ—Å—Ç–∞)", "–ë—É–∫–ª–µ—Ç",
        "–ü–µ—Ä–≥–∞–º–µ–Ω—Ç", "–§–æ–ª—å–≥–∞",
        "–ö–∞—Å—Å–æ–≤–∞—è –ª–µ–Ω—Ç–∞ –º.", "–ö–∞—Å—Å–æ–≤–∞—è –ª–µ–Ω—Ç–∞ –±.",
        "–õ–µ–Ω—Ç–∞ –¥–ª—è –ø–∏—Å—Ç–æ–ª–µ—Ç–∞", "–°–º–µ–Ω–Ω—ã–µ –∫–∞—Å—Å–µ—Ç—ã", "–°–µ–π—Ñ-–ø–∞–∫–µ—Ç—ã",
        "–°–∞–ª—Ñ–µ—Ç–∫–∏", "–¢—Ä—è–ø–∫–∏", "–ì—É–±–∫–∏", "–¢–µ—Ä–∫–∏",
        "–¢—Ä—è–ø–∫–∞ –¥–ª—è –ø–æ–ª–∞", "–°—Ä–µ–¥—Å—Ç–≤–æ –¥–ª—è –ø–æ—Å—É–¥—ã", "–ê–Ω—Ç–∏–∂–∏—Ä",
        "–ü–∞–∫–µ—Ç –º—É—Å–æ—Ä–Ω—ã–π –º.", "–ü–∞–∫–µ—Ç –º—É—Å–æ—Ä–Ω—ã–π –±.",
        "–ü–µ—Ä—á–∞—Ç–∫–∏ —Ü–µ–ª–æ—Ñ–∞–Ω–æ–≤—ã–µ –º.", "–ü–µ—Ä—á–∞—Ç–∫–∏ —Ü–µ–ª–æ—Ñ–∞–Ω–æ–≤—ã–µ l",
        "–ü–µ—Ä—á–∞—Ç–∫–∏ –≤–∏–Ω–∏–ª–æ–≤—ã–µ", "–ü–æ–ª–æ—Ç–µ–Ω—Ü–µ –±—É–º–∞–∂–Ω–æ–µ"
    ],
    "–£–±–æ—Ä–∫–∞": [
        "–ú–æ—é—â–µ–µ —Å—Ä–µ–¥—Å—Ç–≤–æ", "–ì—É–±–∫–∏", "–ü–µ—Ä—á–∞—Ç–∫–∏", "–¢—Ä—è–ø–∫–∏", "–ú–µ—à–∫–∏ –¥–ª—è –º—É—Å–æ—Ä–∞", "–°–∞–ª—Ñ–µ—Ç–∫–∏"
    ]
}

units = ["—à—Ç", "—É–ø–∞–∫", "–∫–≥", "–ª"]

# –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π
user_sessions = {}

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO
)
logger = logging.getLogger(__name__)

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start"""
    user_id = update.message.from_user.id
    user_sessions[user_id] = {
        "username": update.message.from_user.username,
        "department": None,
        "items": [],
        "order": {},
        "all_items": {},
        "current_item_index": 0
    }
    return await select_department(update, context)

async def select_department(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–í—ã–±–æ—Ä –æ—Ç–¥–µ–ª–∞"""
    user_id = update.message.from_user.id
    
    if update.message.text in ('/start', NEW_ORDER_BUTTON, CHANGE_DEPARTMENT_BUTTON):
        user_sessions[user_id] = {
            "username": update.message.from_user.username,
            "department": None,
            "items": [],
            "order": {},
            "all_items": {},
            "current_item_index": 0
        }
        
        keyboard = [[dept] for dept in departments.keys()]
        await update.message.reply_text(
            "–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª:",
            reply_markup=ReplyKeyboardMarkup(
                keyboard, one_time_keyboard=True, resize_keyboard=True
            ),
        )
        return SELECT_DEPARTMENT

    department = update.message.text
    if department not in departments:
        await update.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª –∏–∑ —Å–ø–∏—Å–∫–∞:")
        return SELECT_DEPARTMENT

    user_sessions[user_id].update({
        "department": department,
        "items": departments[department],
        "all_items": {item: "0—à—Ç" for item in departments[department]},
        "current_item_index": 0
    })

    await ask_for_quantity(update, context)
    return INPUT_QUANTITY

async def ask_for_quantity(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ó–∞–ø—Ä–æ—Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å –∫–Ω–æ–ø–∫–æ–π –ø—Ä–æ–ø—É—Å–∫–∞"""
    user_id = update.message.from_user.id
    session = user_sessions.get(user_id)
    
    if not session:
        await update.message.reply_text("–°–µ—Å—Å–∏—è —É—Å—Ç–∞—Ä–µ–ª–∞. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ /start")
        return ConversationHandler.END

    item = session["items"][session["current_item_index"]]
    
    keyboard = [
        [SKIP_BUTTON],
        [BACK_BUTTON] if session["current_item_index"] > 0 else [],
        [CHANGE_DEPARTMENT_BUTTON, CANCEL_BUTTON]
    ]
    
    await update.message.reply_text(
        f"–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è {item}:",
        reply_markup=ReplyKeyboardMarkup(
            keyboard, one_time_keyboard=True, resize_keyboard=True
        ),
    )

async def handle_quantity(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞"""
    user_id = update.message.from_user.id
    session = user_sessions.get(user_id)
    
    if not session:
        await update.message.reply_text("–°–µ—Å—Å–∏—è —É—Å—Ç–∞—Ä–µ–ª–∞. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ /start")
        return ConversationHandler.END

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ–ø—É—Å–∫–∞
    if update.message.text == SKIP_BUTTON:
        return await skip_ingredient(update, context)
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—Ä—É–≥–∏—Ö –∫–Ω–æ–ø–æ–∫
    if update.message.text == BACK_BUTTON:
        return await go_back(update, context)
    elif update.message.text == CHANGE_DEPARTMENT_BUTTON:
        return await select_department(update, context)
    elif update.message.text == CANCEL_BUTTON:
        return await cancel(update, context)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–≤–æ–¥–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    try:
        quantity = float(update.message.text)
        if quantity < 0:
            await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ:")
            return INPUT_QUANTITY
    except ValueError:
        await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ:")
        return INPUT_QUANTITY

    item = session["items"][session["current_item_index"]]
    session["current_quantity"] = quantity
    session["current_item"] = item

    if quantity == 0:
        return await skip_ingredient(update, context)
    else:
        keyboard = [[unit] for unit in units]
        keyboard.append([BACK_BUTTON])
        await update.message.reply_text(
            f"–í—ã–±–µ—Ä–∏—Ç–µ –µ–¥–∏–Ω–∏—Ü—É –¥–ª—è {item}:",
            reply_markup=ReplyKeyboardMarkup(
                keyboard, one_time_keyboard=True, resize_keyboard=True
            ),
        )
        return INPUT_UNIT

async def skip_ingredient(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ü—Ä–æ–ø—É—Å–∫ —Ç–µ–∫—É—â–µ–≥–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞"""
    user_id = update.message.from_user.id
    session = user_sessions.get(user_id)
    
    item = session["items"][session["current_item_index"]]
    session["all_items"][item] = "0—à—Ç"
    session["current_item_index"] += 1
    
    if session["current_item_index"] < len(session["items"]):
        await ask_for_quantity(update, context)
        return INPUT_QUANTITY
    else:
        return await confirm_order(update, context)

async def handle_unit(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è"""
    user_id = update.message.from_user.id
    session = user_sessions.get(user_id)
    
    if not session:
        await update.message.reply_text("–°–µ—Å—Å–∏—è —É—Å—Ç–∞—Ä–µ–ª–∞. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ /start")
        return ConversationHandler.END

    if update.message.text == BACK_BUTTON:
        return await go_back(update, context)
    elif update.message.text == SKIP_BUTTON:
        return await skip_ingredient(update, context)

    if update.message.text not in units:
        await update.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ –µ–¥–∏–Ω–∏—Ü—É –∏–∑ —Å–ø–∏—Å–∫–∞:")
        return INPUT_UNIT

    item = session["current_item"]
    quantity = session["current_quantity"]
    unit = update.message.text
    
    session["all_items"][item] = f"{quantity}{unit}"
    if quantity > 0:
        session["order"][item] = f"{quantity}{unit}"

    session["current_item_index"] += 1
    if session["current_item_index"] < len(session["items"]):
        await ask_for_quantity(update, context)
        return INPUT_QUANTITY
    else:
        return await confirm_order(update, context)

async def go_back(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–í–æ–∑–≤—Ä–∞—Ç –Ω–∞ —à–∞–≥ –Ω–∞–∑–∞–¥"""
    user_id = update.message.from_user.id
    session = user_sessions.get(user_id)
    
    if not session:
        await update.message.reply_text("–°–µ—Å—Å–∏—è —É—Å—Ç–∞—Ä–µ–ª–∞. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ /start")
        return ConversationHandler.END

    if session["current_item_index"] > 0:
        session["current_item_index"] -= 1
        await ask_for_quantity(update, context)
        return INPUT_QUANTITY
    else:
        return await select_department(update, context)

async def confirm_order(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞"""
    user_id = update.message.from_user.id
    session = user_sessions.get(user_id)
    
    if not session:
        await update.message.reply_text("–°–µ—Å—Å–∏—è —É—Å—Ç–∞—Ä–µ–ª–∞. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ /start")
        return ConversationHandler.END

    order_lines = [
        f"‚Ä¢ {item}: {qty}" 
        for item, qty in session["all_items"].items() 
        if not qty.startswith("0")
    ]
    
    order_text = (
        f"üì¶ –ó–∞—è–≤–∫–∞ –æ—Ç –æ—Ç–¥–µ–ª–∞ {session['department']}:\n\n" +
        ("\n".join(order_lines) if order_lines else "–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π") +
        f"\n\n–û—Ç–ø—Ä–∞–≤–∏–ª: @{session['username']}"
    )
    
    session["order_text"] = order_text
    
    keyboard = [
        ["‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å", "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å"],
        [CHANGE_DEPARTMENT_BUTTON, NEW_ORDER_BUTTON]
    ]
    
    await update.message.reply_text(
        f"–í–∞—à –∑–∞–∫–∞–∑:\n\n{order_text}\n\n–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ?",
        reply_markup=ReplyKeyboardMarkup(
            keyboard, one_time_keyboard=True, resize_keyboard=True
        ),
    )
    return CONFIRM_ORDER

async def send_order(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–∫–∞–∑–∞ –Ω–∞ —Å–∫–ª–∞–¥"""
    user_id = update.message.from_user.id
    session = user_sessions.get(user_id)
    
    if not session:
        await update.message.reply_text("–°–µ—Å—Å–∏—è —É—Å—Ç–∞—Ä–µ–ª–∞. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ /start")
        return ConversationHandler.END

    if update.message.text == "‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å":
        try:
            await context.bot.send_message(
                chat_id=-1002322687297,
                text=session["order_text"]
            )
            await update.message.reply_text(
                "‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Å–∫–ª–∞–¥!",
                reply_markup=ReplyKeyboardMarkup(
                    [[NEW_ORDER_BUTTON]], resize_keyboard=True
                )
            )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")
            await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        return ConversationHandler.END
        
    elif update.message.text == NEW_ORDER_BUTTON:
        return await select_department(update, context)
        
    elif update.message.text == CHANGE_DEPARTMENT_BUTTON:
        return await select_department(update, context)
        
    else:
        return await cancel(update, context)

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–∞"""
    user_id = update.message.from_user.id
    user_sessions.pop(user_id, None)
    
    await update.message.reply_text(
        "–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω. –ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ, –Ω–∞–∂–º–∏—Ç–µ /start",
        reply_markup=ReplyKeyboardMarkup([["/start"]], resize_keyboard=True)
    )
    return ConversationHandler.END

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫"""
    logger.error(msg="–û—à–∏–±–∫–∞ –≤ –±–æ—Ç–µ:", exc_info=context.error)
    
    if update and update.message:
        await update.message.reply_text(
            "‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ /start"
        )

def main() -> None:
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    application = Application.builder().token(TOKEN).build()

    conv_handler = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            SELECT_DEPARTMENT: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, select_department)
            ],
            INPUT_QUANTITY: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_quantity)
            ],
            INPUT_UNIT: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_unit)
            ],
            CONFIRM_ORDER: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, send_order)
            ],
        },
        fallbacks=[CommandHandler("cancel", cancel)],
    )

    application.add_handler(conv_handler)
    application.add_error_handler(error_handler)

    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == "__main__":
    main()
